<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Liste des Actions S&P 500 - Simplified Action</title>
     <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: Arial, Helvetica, sans-serif;
            background-color: #f8f9fa; 
            color: #212529; 
            line-height: 1.6;
        }

        header { 
            background: linear-gradient(90deg, #0d6efd, #0a58ca); 
            color: white; 
            padding: 20px; 
            text-align: center; 
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }
        header h1 { margin-bottom: 10px; font-size: 1.8rem; }
        header nav { display: flex; justify-content: center; gap: 25px; align-items: center; flex-wrap: wrap; }
        header a { 
            color: white; 
            text-decoration: none; 
            font-weight: 500; 
            transition: opacity 0.2s ease-in-out;
        }
        header a:hover { opacity: 0.8; }
        header button { 
            background: #dc3545; 
            color: white; 
            border: none; 
            padding: 10px 16px; 
            cursor: pointer; 
            border-radius: 20px; 
            font-weight: 500; 
            transition: background 0.3s ease;
        }
        header button:hover { background: #bb2d3b; }

        .main-content { padding: 30px; max-width: 1400px; margin: 0 auto; }

        .search-container { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 25px; 
        }
        .search-container input { 
            flex: 1; 
            padding: 14px; 
            border: 1px solid #ced4da; 
            border-radius: 8px; 
            font-size: 16px; 
            outline: none; 
            transition: border 0.3s;
        }
        .search-container input:focus { border-color: #0d6efd; }
        .search-container button { 
            padding: 14px 20px; 
            background: #0d6efd; 
            color: white; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: 500; 
            transition: background 0.3s ease;
        }
        .search-container button:hover { background: #0a58ca; }

        .loader { text-align: center; padding: 40px; font-size: 18px; color: #6c757d; }
        .error-message { 
            color: #842029; 
            padding: 12px; 
            background: #f8d7da; 
            border: 1px solid #f5c2c7; 
            border-radius: 8px; 
            margin-bottom: 20px; 
            display: none; 
        }

        .stats { 
            background: white; 
            border-radius: 8px; 
            padding: 15px; 
            margin-bottom: 20px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .stats p { margin: 5px 0; }

        .actions-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
            gap: 20px; 
            margin-bottom: 20px;
            justify-items: center;
        }

        /* From Uiverse.io by SouravBandyopadhyay */
        .card {
            display: block;
            position: relative;
            width: 100%;
            max-width: 320px;
            min-height: 280px;
            background-color: #f2f8f9;
            border-radius: 10px;
            padding: 2em 1.2em;
            text-decoration: none;
            z-index: 0;
            overflow: hidden;
            background: linear-gradient(to bottom, #c3e6ec, #a7d1d9);
            font-family: Arial, Helvetica, sans-serif;
            cursor: pointer;
        }

        .card:before {
            content: '';
            position: absolute;
            z-index: -1;
            top: -16px;
            right: -16px;
            background: linear-gradient(135deg, #364a60, #384c6c);
            height: 32px;
            width: 32px;
            border-radius: 32px;
            transform: scale(1);
            transform-origin: 50% 50%;
            transition: transform 0.35s ease-out;
        }

        .card:hover:before {
            transform: scale(28);
        }

        .card-title {
            color: #262626;
            font-size: 1.8em;
            line-height: normal;
            font-weight: 700;
            margin-bottom: 0.5em;
        }

        .card:hover .card-title {
            transition: all 0.5s ease-out;
            color: #ffffff;
        }

        .small-desc {
            font-size: 1em;
            font-weight: 400;
            line-height: 1.5em;
            color: #452c2c;
            margin-bottom: 1em;
        }

        .card:hover .small-desc {
            transition: all 0.5s ease-out;
            color: rgba(255, 255, 255, 0.8);
        }

        .go-corner {
            display: flex;
            align-items: center;
            justify-content: center;
            position: absolute;
            width: 2em;
            height: 2em;
            overflow: hidden;
            top: 0;
            right: 0;
            background: linear-gradient(135deg, #6293c8, #384c6c);
            border-radius: 0 4px 0 32px;
        }

        .go-arrow {
            margin-top: -4px;
            margin-right: -4px;
            color: white;
            font-family: courier, sans-serif;
            font-size: 1.2em;
        }

        .card-info {
            margin: 0.5em 0;
            font-size: 0.95em;
        }

        .card-info strong {
            font-weight: 600;
            color: #262626;
        }

        .card:hover .card-info strong {
            transition: all 0.5s ease-out;
            color: #ffffff;
        }

        .card:hover .card-info {
            transition: all 0.5s ease-out;
            color: rgba(255, 255, 255, 0.9);
        }

        .add-favorite {
            margin-top: 15px;
            padding: 10px 15px;
            background: linear-gradient(135deg, #198754, #157347);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            width: 100%;
            transition: all 0.3s ease;
            position: relative;
            z-index: 1;
        }

        .add-favorite:hover {
            background: linear-gradient(135deg, #157347, #0f5132);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(21, 115, 71, 0.4);
        }

        .card:hover .add-favorite {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.8);
            color: #ffffff;
        }

        .card:hover .add-favorite:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(400px); opacity: 0; }
        }

        @media (max-width: 768px) {
            .actions-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <h1>Liste des Actions du S&P 500</h1>
        <nav>
            <a href="index.html">Accueil</a>
            <a href="account.html">Compte</a>
            <button id="logoutBtn" style="display: none;">Déconnexion</button>
        </nav>
    </header>

    <main class="main-content">
        <div id="stats" class="stats" style="display: none;">
            <p><strong>Total d'entreprises:</strong> <span id="totalCompanies">0</span></p>
            <p><strong>Entreprises affichées:</strong> <span id="visibleCompanies">0</span></p>
        </div>

        <div class="search-container">
            <input type="text" id="searchInput" placeholder="Rechercher une action (ticker ou nom)...">
            <button id="clearSearch">Effacer</button>
        </div>

        <div id="loader" class="loader">Chargement de la liste S&P 500...</div>
        <div id="errorMessage" class="error-message"></div>
        <div id="actionsList" class="actions-grid" style="display: none;"></div>
    </main>

    <script>
    let sp500Data = [];

    const fallbackData = [
        { Symbol: "AAPL", Security: "Apple Inc.", Sector: "Information Technology" },
        { Symbol: "MSFT", Security: "Microsoft Corporation", Sector: "Information Technology" },
        { Symbol: "GOOGL", Security: "Alphabet Inc. Class A", Sector: "Communication Services" },
        { Symbol: "GOOG", Security: "Alphabet Inc. Class C", Sector: "Communication Services" },
        { Symbol: "AMZN", Security: "Amazon.com Inc.", Sector: "Consumer Discretionary" },
        { Symbol: "NVDA", Security: "NVIDIA Corporation", Sector: "Information Technology" },
        { Symbol: "META", Security: "Meta Platforms Inc.", Sector: "Communication Services" },
        { Symbol: "TSLA", Security: "Tesla Inc.", Sector: "Consumer Discretionary" },
        { Symbol: "BRK.B", Security: "Berkshire Hathaway Inc. Class B", Sector: "Financials" },
        { Symbol: "JPM", Security: "JPMorgan Chase & Co.", Sector: "Financials" },
        { Symbol: "V", Security: "Visa Inc.", Sector: "Financials" },
        { Symbol: "JNJ", Security: "Johnson & Johnson", Sector: "Health Care" },
        { Symbol: "WMT", Security: "Walmart Inc.", Sector: "Consumer Staples" },
        { Symbol: "PG", Security: "Procter & Gamble Co.", Sector: "Consumer Staples" },
        { Symbol: "MA", Security: "Mastercard Inc.", Sector: "Financials" },
        { Symbol: "HD", Security: "Home Depot Inc.", Sector: "Consumer Discretionary" },
        { Symbol: "BAC", Security: "Bank of America Corp.", Sector: "Financials" },
        { Symbol: "XOM", Security: "Exxon Mobil Corporation", Sector: "Energy" },
        { Symbol: "CVX", Security: "Chevron Corporation", Sector: "Energy" },
        { Symbol: "KO", Security: "Coca-Cola Co.", Sector: "Consumer Staples" },
        { Symbol: "PEP", Security: "PepsiCo Inc.", Sector: "Consumer Staples" },
        { Symbol: "COST", Security: "Costco Wholesale Corporation", Sector: "Consumer Staples" },
        { Symbol: "ABBV", Security: "AbbVie Inc.", Sector: "Health Care" },
        { Symbol: "MRK", Security: "Merck & Co. Inc.", Sector: "Health Care" },
        { Symbol: "TMO", Security: "Thermo Fisher Scientific Inc.", Sector: "Health Care" },
        { Symbol: "AVGO", Security: "Broadcom Inc.", Sector: "Information Technology" },
        { Symbol: "ORCL", Security: "Oracle Corporation", Sector: "Information Technology" },
        { Symbol: "ACN", Security: "Accenture plc", Sector: "Information Technology" },
        { Symbol: "CSCO", Security: "Cisco Systems Inc.", Sector: "Information Technology" },
        { Symbol: "ADBE", Security: "Adobe Inc.", Sector: "Information Technology" },
        { Symbol: "CRM", Security: "Salesforce Inc.", Sector: "Information Technology" },
        { Symbol: "NFLX", Security: "Netflix Inc.", Sector: "Communication Services" },
        { Symbol: "DIS", Security: "Walt Disney Co.", Sector: "Communication Services" },
        { Symbol: "CMCSA", Security: "Comcast Corporation", Sector: "Communication Services" },
        { Symbol: "PFE", Security: "Pfizer Inc.", Sector: "Health Care" },
        { Symbol: "ABT", Security: "Abbott Laboratories", Sector: "Health Care" },
        { Symbol: "DHR", Security: "Danaher Corporation", Sector: "Health Care" },
        { Symbol: "NKE", Security: "Nike Inc.", Sector: "Consumer Discretionary" },
        { Symbol: "MCD", Security: "McDonald's Corporation", Sector: "Consumer Discretionary" },
        { Symbol: "LIN", Security: "Linde plc", Sector: "Materials" },
        { Symbol: "TXN", Security: "Texas Instruments Inc.", Sector: "Information Technology" },
        { Symbol: "INTC", Security: "Intel Corporation", Sector: "Information Technology" },
        { Symbol: "QCOM", Security: "QUALCOMM Inc.", Sector: "Information Technology" },
        { Symbol: "AMD", Security: "Advanced Micro Devices Inc.", Sector: "Information Technology" },
        { Symbol: "UNH", Security: "UnitedHealth Group Inc.", Sector: "Health Care" },
        { Symbol: "CVS", Security: "CVS Health Corporation", Sector: "Health Care" },
        { Symbol: "WFC", Security: "Wells Fargo & Co.", Sector: "Financials" },
        { Symbol: "MS", Security: "Morgan Stanley", Sector: "Financials" },
        { Symbol: "GS", Security: "Goldman Sachs Group Inc.", Sector: "Financials" },
        { Symbol: "AXP", Security: "American Express Co.", Sector: "Financials" }
    ];

    async function fetchSP500Data() {
        const loader = document.getElementById('loader');
        
        try {
            loader.textContent = "Tentative de chargement depuis Wikipedia...";
            
            const wikiResponse = await fetch('https://en.wikipedia.org/api/rest_v1/page/html/List_of_S%26P_500_companies', {
                headers: { 'Accept': 'text/html' }
            });
            
            if (wikiResponse.ok) {
                const html = await wikiResponse.text();
                sp500Data = parseWikipediaHTML(html);
                
                if (sp500Data.length > 0) {
                    displaySP500List(sp500Data);
                    return;
                }
            }
        } catch (error) {
            console.error('Wikipedia failed:', error);
        }

        try {
            loader.textContent = "Tentative de chargement depuis FMP...";
            
            const fmpResponse = await fetch('https://financialmodelingprep.com/api/v3/sp500_constituent?apikey=demo');
            
            if (fmpResponse.ok) {
                const fmpData = await fmpResponse.json();
                
                if (Array.isArray(fmpData) && fmpData.length > 0) {
                    sp500Data = fmpData.map(item => ({
                        Symbol: item.symbol,
                        Security: item.name,
                        Sector: item.sector || 'N/A'
                    }));
                    
                    displaySP500List(sp500Data);
                    return;
                }
            }
        } catch (error) {
            console.error('FMP failed:', error);
        }

        loader.textContent = "Chargement des données de démonstration...";
        console.log('Using fallback data');
        sp500Data = fallbackData;
        displaySP500List(sp500Data);
    }

    function parseWikipediaHTML(html) {
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const table = doc.querySelector('table.wikitable');
        
        if (!table) return [];
        
        const rows = Array.from(table.querySelectorAll('tr')).slice(1);
        
        return rows.map(row => {
            const cells = row.querySelectorAll('td');
            if (cells.length < 3) return null;
            
            return {
                Symbol: cells[0]?.textContent.trim() || '',
                Security: cells[1]?.textContent.trim() || '',
                Sector: cells[2]?.textContent.trim() || 'N/A'
            };
        }).filter(item => item && item.Symbol);
    }

    async function initPage() {
        try {
            // Attendre que l'authentification soit initialisée
            if (typeof authManager !== 'undefined') {
                await authManager.init();
                const user = authManager.getCurrentUser();
                if (user) {
                    document.getElementById('logoutBtn').style.display = 'block';
                    document.getElementById('logoutBtn').addEventListener('click', () => {
                        if (typeof logout === 'function') logout();
                    });
                }
            }

            await fetchSP500Data();
        } catch (error) {
            showError('Erreur lors de l\'initialisation: ' + error.message);
            console.error(error);
        }
    }

    function displaySP500List(data) {
        const container = document.getElementById('actionsList');
        const loader = document.getElementById('loader');
        const statsDiv = document.getElementById('stats');
        
        if (!data || data.length === 0) {
            showError('Aucune donnée disponible');
            return;
        }

        data.sort((a, b) => a.Symbol.localeCompare(b.Symbol));
        
        loader.style.display = 'none';
        container.style.display = 'grid';
        statsDiv.style.display = 'block';
        container.innerHTML = '';

        document.getElementById('totalCompanies').textContent = data.length;
        document.getElementById('visibleCompanies').textContent = data.length;

        data.forEach(action => {
            const card = createActionCard(action);
            container.appendChild(card);
        });

        initSearch();
    }

    function createActionCard(action) {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
            <p class="card-title">${action.Symbol}</p>
            <p class="small-desc">${action.Security}</p>
            <p class="card-info"><strong>Secteur:</strong> ${action.Sector}</p>
            <button class="add-favorite" data-symbol="${action.Symbol}">⭐ Ajouter aux favoris</button>
            <div class="go-corner">
                <div class="go-arrow">→</div>
            </div>
        `;
        const favBtn = card.querySelector('.add-favorite');
        favBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            addToFavorites(action.Symbol);
        });
        return card;
    }

    function initSearch() {
        const searchInput = document.getElementById('searchInput');
        const clearBtn = document.getElementById('clearSearch');
        const cards = document.querySelectorAll('.card');

        searchInput.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase().trim();
            let visibleCount = 0;

            cards.forEach(card => {
                const text = card.textContent.toLowerCase();
                
                if (text.includes(query)) {
                    card.style.display = 'block';
                    visibleCount++;
                } else {
                    card.style.display = 'none';
                }
            });

            document.getElementById('visibleCompanies').textContent = visibleCount;
        });

        clearBtn.addEventListener('click', () => {
            searchInput.value = '';
            cards.forEach(card => card.style.display = 'block');
            document.getElementById('visibleCompanies').textContent = cards.length;
        });
    }

    function addToFavorites(symbol) {
        showToast(`Action ${symbol} ajoutée aux favoris !`);
    }

    function showError(message) {
        const errorDiv = document.getElementById('errorMessage');
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
        document.getElementById('loader').style.display = 'none';
    }

    function showToast(message) {
        const toast = document.createElement('div');
        toast.style.cssText = `
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #198754;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            animation: slideIn 0.3s ease;
        `;
        toast.textContent = message;
        document.body.appendChild(toast);

        setTimeout(() => {
            toast.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    document.addEventListener('DOMContentLoaded', initPage);
    </script>

    <!-- Scripts refactorisés -->
    <script src="js/auth.js"></script>
    <script src="js/auth-guard.js"></script>
    <script src="js/favorites.js"></script>
</body>
</html>